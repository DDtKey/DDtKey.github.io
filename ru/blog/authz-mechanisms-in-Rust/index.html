<!DOCTYPE html>
<html lang="en">
<html class="dark light">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    
    
    <title>
         Механизмы авторизации в web-приложениях на Rust
        
    </title>

        
            <meta property="og:title" content="Механизмы авторизации в web-приложениях на Rust" />
        
     

     
         
     

     
         
    

    
    
        <link rel="icon" type="image/png" href=&#x2F;icons&#x2F;favicon-32x32.png />
    

    
    
        <link href=https://ddtkey.com/fonts.css rel="stylesheet" />
    

    
    
        

        
            
            

            <script data-goatcounter="https://ddtkey.goatcounter.com/count" async src="https://ddtkey.com/js/count.js"></script>
            <noscript>
                
                <img src="https://ddtkey.goatcounter.com//count?p=&#x2F;ru&#x2F;blog&#x2F;authz-mechanisms-in-Rust&#x2F;&t=Механизмы авторизации в web-приложениях на Rust">
            </noscript>
        
    


    

    
    <link rel="alternate" type="application/atom+xml" title="DDtKey" href="https://ddtkey.com/atom.xml">


    
    
        <link rel="stylesheet" type="text/css" href=https://ddtkey.com/theme/light.css />
        <link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://ddtkey.com/theme/dark.css" />
    
    
    <!-- Set the correct theme in the script -->
    <script src=https://ddtkey.com/js/themetoggle.js></script>
    
        <script>setTheme(getSavedTheme());</script>
    

    <link rel="stylesheet" type="text/css" media="screen" href=https://ddtkey.com/main.css />

    
</head>



    <link id="syntax_highlight_dark" href=https://ddtkey.com/css/syntax-dark.css rel="stylesheet" />
    <link id="syntax_highlight_light" href=https://ddtkey.com/css/syntax-light.css rel="stylesheet" />
    <script src=https://ddtkey.com/js/syntax-highlight-switch.js defer></script>


<body>
    <div class="content">
        <header>
    <div class="main">
        <a href=https:&#x2F;&#x2F;ddtkey.com>DDtKey</a>

        <div class="socials">
            
            <a rel="me" href="https:&#x2F;&#x2F;github.com&#x2F;ddtkey" class="social">
                <img alt=github src=https://ddtkey.com/social_icons/github.svg>
            </a>
            
            <a rel="me" href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;ddtkey" class="social">
                <img alt=linkedin src=https://ddtkey.com/social_icons/linkedin.svg>
            </a>
            
            <a rel="me" href="https:&#x2F;&#x2F;t.me&#x2F;ddtkey" class="social">
                <img alt=telegram src=https://ddtkey.com/social_icons/telegram.svg>
            </a>
            
            <a rel="me" href="mailto:i@ddtkey" class="social">
                <img alt=email src=https://ddtkey.com/social_icons/email.svg>
            </a>
            
            <a rel="me" href="https:&#x2F;&#x2F;twitter.com&#x2F;ddttkey" class="social">
                <img alt=twitter src=https://ddtkey.com/social_icons/x-twitter.svg>
            </a>
            
        </div>
    </div>

    <nav>
        
        <a href=https://ddtkey.com/blog style="margin-left: 0.7em">&#x2F;blog</a>
        
        <a href=https://ddtkey.com/projects style="margin-left: 0.7em">&#x2F;projects</a>
        
        <a href=https://ddtkey.com/about style="margin-left: 0.7em">&#x2F;about</a>
        

        
        <a id="dark-mode-toggle" onclick="toggleTheme(); event.preventDefault();" href="#">
            <img src=https://ddtkey.com/feather/sun.svg id="sun-icon" style="filter: invert(1);" alt="Light" />
            <img src=https://ddtkey.com/feather/moon.svg id="moon-icon" alt="Dark" />
        </a>

        <!-- Inititialize the theme toggle icons -->
        <script>updateItemToggleTheme()</script>
        
    </nav>
</header>


        
        
    

<main>
    <article>
        <div class="title">
            
            

    <div class="page-header">
        Механизмы авторизации в web-приложениях на Rust<span class="primary-color" style="font-size: 1.6em">.</span>
    </div>



                <div class="meta">
                    
                        Posted on <time>2021-05-10</time>
                    

                    
                </div>
        </div>

        

        
        
            
                <h1>Table of Contents</h1>
                <ul>
                
                    <li>
                        <a href="https://ddtkey.com/ru/blog/authz-mechanisms-in-Rust/#vvedenie">Введение</a>
                        
                            <ul>
                                
                                    <li>
                                        <a href="https://ddtkey.com/ru/blog/authz-mechanisms-in-Rust/#modeli-kontrolia-dostupa">Модели контроля доступа</a>
                                    </li>

                                    
                                
                            </ul>
                        
                    </li>
                
                    <li>
                        <a href="https://ddtkey.com/ru/blog/authz-mechanisms-in-Rust/#chto-my-imeem-v-veb-freimvorkakh-na-rust">Что мы имеем в веб-фреймворках на Rust?</a>
                        
                            <ul>
                                
                                    <li>
                                        <a href="https://ddtkey.com/ru/blog/authz-mechanisms-in-Rust/#casbin-rs">casbin-rs</a>
                                    </li>

                                    
                                
                                    <li>
                                        <a href="https://ddtkey.com/ru/blog/authz-mechanisms-in-Rust/#actix-web-grants">actix-web-grants</a>
                                    </li>

                                    
                                    <ul>
                                        
                                            <li>
                                                <a href="https://ddtkey.com/ru/blog/authz-mechanisms-in-Rust/#post-scriptum">Post Scriptum</a>
                                            </li>
                                        
                                    </ul>
                                    
                                
                            </ul>
                        
                    </li>
                
                </ul>
            
        

        <section class="body">
            <p align="center">
<img src="/images/posts/authz-in-rust/preview.png"/>
</p>
<h2 id="vvedenie">Введение</h2>
<p>Для обеспечения безопасности приложений мы используем такие механизмы как аутентификация и авторизация. Думаю, многие из вас знакомы с этими концепциями и в этой статье мы сфокусируемся на понятие авторизации и связанных с ней моделях контроля доступа.</p>
<p align="center">
<img alt="security" width="500" src="/images/posts/authz-in-rust/security.png"/>
</p>
<details markdown="1">
<summary><b><i>Определения терминов, которые используются в статье</i></b></summary>
<p>Важно понимать отличия авторизации от аутентификации:</p>
<blockquote>
<p><strong><em>Аутентификация</em></strong> – процесс подтверждения вашей личности и доказательства того, что вы являетесь непосредственным клиентом системы (посредством пароля, токена или любой другой формы учетных данных).</p>
</blockquote>
<blockquote>
<p><strong><em>Авторизация</em></strong> в свою очередь – это механизм, в результате которого запрос к определенному ресурсу системы должен быть разрешен или отклонен.</p>
</blockquote>
<blockquote>
<p><strong><em>Субъект доступа</em></strong> – пользователь или процесс, который запрашивает доступ к ресурсу.</p>
</blockquote>
<blockquote>
<p><strong><em>Объект доступа</em></strong> – напротив, является ресурсом, к которому запрашивается доступ со стороны субъекта.</p>
</blockquote>
<blockquote>
<p><strong><em>Крейт</em> (<em>Crate</em>)</strong> – библиотека или исполняемая программа в Rust.</p>
</blockquote>
</details>
<p>К процессу авторизации относится понятие <strong><em>политики контроля доступа</em></strong>, в соответствии с которой и определяется набор допустимых действий конкретного пользователя (субъекта доступа) над ресурсами системы (объект доступа).</p>
<p>А также <strong><em>модель контроля доступа</em></strong> – общая схема для разграничения доступа посредством пользовательской политики, которую мы выбираем в зависимости от различных факторов и требований к системе.</p>
<h3 id="modeli-kontrolia-dostupa">Модели контроля доступа</h3>
<p><strong>Давайте рассмотрим основные модели контроля доступа:</strong></p>
<ul>
<li><strong>DAC</strong> (<em>Discretionary access-control</em>) – избирательное (дискреционное) управление доступом</li>
</ul>
<img alt="Discretionary access-control" width="200" align="right" src="/images/posts/authz-in-rust/dac.png"/>
<p>Данная парадигма позволяет пользователям самостоятельно передавать право на какие-либо действия над его данными другим участникам системы, для чего используются <em>списки контроля доступа</em> (<strong>ACL</strong>).</p>
<p>Наиболее распространено применение в случаях, когда пользователи непосредственно владеют некими ресурсами и могут самостоятельно решать кому позволять взаимодействие с ними.</p>
<p>Примером могут служить операционные системы или социальные сети, где люди самостоятельно меняют видимость их контента.</p>
<ul>
<li><strong>MAC</strong> (<em>Mandatory access-control</em>) – мандатное управление доступом</li>
</ul>
<img alt="Discretionary access-control" width="200" align="left" src="/images/posts/authz-in-rust/mac.png"/>
<p>Была разработана в государственных целях с акцентом на применение в чрезвычайно защищенных системах (например, военных), где и получила наибольшее распространение.</p>
<p>Защита данных основана на метках конфиденциальности (уровень секретности или важности), с помощью которых происходит проверка наличия уровня доступа у субъектов.  Характерным также является централизованная выдача прав управляющим органом.</p>
<p>Пожалуй, MAC одна из самых строгих и безопасных моделей, но с этим связана сложность и высокая стоимостьреализации и поддержания инфраструктуры вокруг этого решения (есть множество способов, требующих тщательного планирования).</p>
<ul>
<li><strong>RBAC</strong> (<em>Role-Based access-control</em>) – управление доступом на основе ролей</li>
</ul>
<p>Наиболее распространенная и многим известная модель, которая хорошо накладывается на предметные бизнес-области и коррелирует с должностными функциями. Является неким развитием <em>DAC</em>, где привилегии группируются в соответствующие им роли.</p>
<p>Каждый субъект может обладать перечнем ролей, где роль в свою очередь может предоставлять доступ к некому перечню объектов.</p>
<p>Следует отметить, что в рамках RBAC иногда выделяют <strong>PBAC</strong> (<em>Permission-Based access-control</em>) модель контроля доступа на основе разрешений, когда для каждого ресурса системы выделяется набор действий (например: <code>READ_DOCUMENT</code>, <code>WRITE_DOCUMENT</code>, <code>DELETE_DOCUMENT</code>) и связывают с субъектом через соотношение с ролями, напрямую с пользователем или гибридным подходом – где субъект может обладать ролью и отдельными привилегиями.</p>
<ul>
<li><strong>ABAC</strong> (<em>Attribute-Based access-control</em>) – управление доступом на основе атрибутов</li>
</ul>
<p align="center">
<img alt="Discretionary access-control" width="500" src="/images/posts/authz-in-rust/abac.png"/>
</p>
<p>В данном подходе необходимо ведение специальных политик, которые объединяют атрибуты субъектов и объектов, а решение о допуске предоставляется на основе анализа и сравнительной оценки этих атрибутов.</p>
<p>Это наиболее гибкий из описанных подходов с огромным количеством возможных комбинаций, который позволяет принимать решения на основе таких параметров, как время запроса, местоположение, должность сотрудника и т.п., но требует более детального планирования политик для предотвращения несанкционированного доступа.</p>
<p>Для применения ABAC требуется некий механизм интерпретации политик и некого синтаксического подмножества, что может влечь за собой затраты времени исполнения (в случае динамической реализации) или компиляции (при генерации кода).</p>
<p>Подробнее о некоторых из них можно почитать в <a rel="noopener" target="_blank" href="https://cheatsheetseries.owasp.org/cheatsheets/Access_Control_Cheat_Sheet.html#permission-based-access-control">материалах OWASP</a> (Open Web Application Security Project) и в <a rel="noopener" target="_blank" href="https://www.ibm.com/docs/en/sig-and-i/10.0.0?topic=planning-access-control-models">документации IBM</a>.</p>
<p>Контроль доступа составляет очень важную часть веб приложений, поскольку необходимо строго соблюдать разграничение доступа к ресурсам и данным в зависимости от привилегий пользователей и в особенности персональным данным, защита которых предусмотрена законодательными аспектами.</p>
<hr />
<h2 id="chto-my-imeem-v-veb-freimvorkakh-na-rust">Что мы имеем в веб-фреймворках на Rust?</h2>
<p>Как правило, для реализации механизмов защиты от несанкционированного доступа в популярных веб-фреймворках (таких, как actix-web, Rocket или tide), используются реализации <code>Middleware</code>, <code>FromRequest</code> или <code>Guard</code> (<code>Filter</code> в случае warp).</p>
<p>То есть в неком промежуточном ПО, где из запросов можно извлечь данные о субъекте и объекте доступа. Такой подход довольно удобен, поскольку позволят разграничить зоны ответственности.</p>
<p>Это могут быть как библиотечные реализации в виде крейтов, так и пользовательские. Но на текущий момент, предпочтения отдают собственным реализациям, что вероятно связано с небольшим количеством готовых реализаций и спецификой применяемых политик в рамках различных проектов.</p>
<h3 id="casbin-rs"><a rel="noopener" target="_blank" href="https://github.com/casbin/casbin-rs">casbin-rs</a></h3>
<p align="center">
    <a href="https://github.com/casbin/casbin-rs">
        <img content="true" alt="casbin-rs" src="/images/posts/authz-in-rust/casbin.png"/>
    </a>
</p>
<p><a rel="noopener" target="_blank" href="https://github.com/casbin/casbin-rs/commits/master"><img src="https://img.shields.io/github/last-commit/casbin/casbin-rs" alt="GitHub last commit" /></a>
<a rel="noopener" target="_blank" href="https://crates.io/crates/casbin"><img src="https://img.shields.io/crates/v/casbin.svg" alt="Crates.io" /></a>
<a rel="noopener" target="_blank" href="https://crates.io/crates/casbin"><img src="https://img.shields.io/crates/d/casbin" alt="crates.io" /></a>
<a rel="noopener" target="_blank" href="https://docs.rs/casbin"><img src="https://docs.rs/casbin/badge.svg" alt="Docs" /></a>
<a rel="noopener" target="_blank" href="https://github.com/casbin/casbin-rs/actions"><img src="https://github.com/casbin/casbin-rs/workflows/CI/badge.svg" alt="CI" /></a>
<a rel="noopener" target="_blank" href="https://codecov.io/gh/casbin/casbin-rs"><img src="https://codecov.io/gh/casbin/casbin-rs/branch/master/graph/badge.svg" alt="Codecov" /></a>
<a rel="noopener" target="_blank" href="https://gitter.im/casbin/lobby"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="Gitter" /></a>
<a rel="noopener" target="_blank" href="https://forum.casbin.org/"><img src="https://img.shields.io/badge/forum-join-%23cde201" alt="forum" /></a></p>
<p>Наиболее обширное production-ready решение с открытым исходным кодом, которое мне удалось найти – это адаптация Casbin (casbin-rs), с внушительным количеством поддерживаемых моделей доступа (заявлены ACL, RBAC, ABAC) и возможностью гибкого изменения политики посредством изменения только лишь конфигурационного файла.</p>
<p>В casbin используется своя мета-модель <em>PERM (Policy, Effect, Request, Matchers)</em> для построения модели доступа, что дает большую гибкость, но привносит затраты на ее интерпретацию и валидацию.</p>
<pre data-lang="ini" class="language-ini z-code"><code class="language-ini" data-lang="ini"><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># Request definition
</span></span><span class="z-storage z-type z-genconfig">[request_definition]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">r</span> <span class="z-keyword z-operator z-genconfig">=</span></span> sub<span class="z-keyword z-operator z-genconfig">,</span> obj<span class="z-keyword z-operator z-genconfig">,</span> act

<span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># Policy definition
</span></span><span class="z-storage z-type z-genconfig">[policy_definition]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">p</span> <span class="z-keyword z-operator z-genconfig">=</span></span> sub<span class="z-keyword z-operator z-genconfig">,</span> obj<span class="z-keyword z-operator z-genconfig">,</span> act

<span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># Policy effect
</span></span><span class="z-storage z-type z-genconfig">[policy_effect]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">e</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-meta z-function z-genconfig"><span class="z-entity z-name z-function z-genconfig">some</span>(</span>where (p<span class="z-keyword z-operator z-genconfig">.</span>eft <span class="z-keyword z-operator z-genconfig">=</span><span class="z-keyword z-operator z-genconfig">=</span> allow))

<span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># Matchers
</span></span><span class="z-storage z-type z-genconfig">[matchers]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">m</span> <span class="z-keyword z-operator z-genconfig">=</span></span> r<span class="z-keyword z-operator z-genconfig">.</span>sub <span class="z-keyword z-operator z-genconfig">=</span><span class="z-keyword z-operator z-genconfig">=</span> p<span class="z-keyword z-operator z-genconfig">.</span>sub &amp;&amp; r<span class="z-keyword z-operator z-genconfig">.</span>obj <span class="z-keyword z-operator z-genconfig">=</span><span class="z-keyword z-operator z-genconfig">=</span> p<span class="z-keyword z-operator z-genconfig">.</span>obj &amp;&amp; r<span class="z-keyword z-operator z-genconfig">.</span>act <span class="z-keyword z-operator z-genconfig">=</span><span class="z-keyword z-operator z-genconfig">=</span> p<span class="z-keyword z-operator z-genconfig">.</span>act
</span></code></pre>
<p>При ее описании можно легко допустить ошибку, в связи с чем был разработан <a rel="noopener" target="_blank" href="https://casbin.org/editor/">веб-редактор моделей</a> для удобной и корректной модификации</p>
<p>Администрирование привилегий для вашей системы происходит через описание политики (в файле или базе данных), соответствующей формату PERM модели.</p>
<pre class="z-code"><code><span class="z-text z-plain">p, alice, data1, read
p, bob, data2, write
</span></code></pre>
<p>К сожалению, это вызывает определенное дублирование идентификаторов объектов и субъектов и неочевидность на уровне вызывающего кода.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">casbin<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">prelude<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">tokio</span>::<span class="z-variable z-annotation z-rust">main</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> e <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Enforcer<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>examples/acl_model.conf<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>examples/acl_policy.csv<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
    e<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">enable_log</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-language z-rust">true</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-storage z-type z-rust">let</span> sub <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>alice<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> the user that wants to access a resource.
</span>    <span class="z-storage z-type z-rust">let</span> obj <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>data1<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> the resource that is going to be accessed.
</span>    <span class="z-storage z-type z-rust">let</span> act <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>read<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> the operation that the user performs on the resource.
</span>
    <span class="z-keyword z-control z-rust">if</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>authorized</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> e<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">enforce</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>sub<span class="z-punctuation z-separator z-rust">,</span> obj<span class="z-punctuation z-separator z-rust">,</span> act</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-keyword z-control z-rust">if</span> authorized <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> permit alice to read data1
</span>        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> deny the request
</span>        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> error occurs
</span>    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Такой инструмент определенно заслуживает уважения.  Огромное спасибо сообществу, которое вносит свой вклад в его развитие!</p>
<p>Но, как мы можем наблюдать, разработчики учитывают определенные нюансы и отсюда вытекает стремление писать собственные решения из проекта в проект, поскольку требования могут быть детерминированы изначально, а вся предоставляемая гибкость может так и не понадобиться, и следовательно, мы вольны выбирать более узкую и легковесную реализацию, подходящую под наши требования.</p>
<p>Как это было и у меня, когда я взялся за написание backend на Rust. Мне было достаточно модели <em>PBAC</em> и исходя из своего опыта разработки веб-приложений, в большинстве типовых проектов достаточно моделей <em>ACL</em>/<em>RBAC</em>.</p>
<p>В связи с чем я пришел к идее реализации и вынесения собственного решения в качестве отдельного крейта с открытым исходным кодом: <em>actix-web-grants</em>.</p>
<h3 id="actix-web-grants"><a rel="noopener" target="_blank" href="https://github.com/DDtKey/actix-web-grants">actix-web-grants</a></h3>
<p align="center">
    <a href="https://github.com/DDtKey/actix-web-grants">
        <img content="true" alt="actix-web-grants" src="/images/posts/authz-in-rust/awg.png"/>
    </a>
</p>
<p><a rel="noopener" target="_blank" href="https://github.com/DDtKey/actix-web-grants/actions"><img src="https://github.com/DDtKey/actix-web-grants/workflows/CI/badge.svg" alt="CI" /></a>
<a rel="noopener" target="_blank" href="https://crates.io/crates/actix-web-grants"><img src="https://img.shields.io/crates/d/actix-web-grants" alt="Crates.io Downloads Badge" /></a>
<a rel="noopener" target="_blank" href="https://crates.io/crates/actix-web-grants"><img src="https://img.shields.io/crates/v/actix-web-grants" alt="crates.io" /></a>
<a rel="noopener" target="_blank" href="https://docs.rs/actix-web-grants"><img src="https://docs.rs/actix-web-grants/badge.svg" alt="Documentation" /></a>
<a rel="noopener" target="_blank" href="https://deps.rs/repo/github/DDtKey/actix-web-grants"><img src="https://deps.rs/repo/github/DDtKey/actix-web-grants/status.svg" alt="dependency status" /></a>
<img src="https://img.shields.io/crates/l/actix-web-grants" alt="Apache 2.0 or MIT licensed" /></p>
<p>Основная идея проекта состоит в использовании встроенной middleware для получения привилегий пользователей из запроса и указанию необходимых разрешений у пользователей непосредственно на ваших эндпоинтах.</p>
<p>Это довольно легковесный крейт с простым подключением, с использованием которого можно, как минимум, применять следующие модели: списки доступа(ACL), управление доступом на основе ролей или разрешений(RBAC/PBAC).</p>
<p>Таким образом, нам достаточно реализовать функцию получения привилегий:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Sample application with grant protection based on extracting by your custom function
</span><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">actix_web</span>::<span class="z-variable z-annotation z-rust">main</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">io<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-path z-rust">HttpServer<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> auth <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">GrantsMiddleware<span class="z-punctuation z-accessor z-rust">::</span></span>with_extractor<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>extract</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-meta z-path z-rust">App<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">wrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>auth</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">service</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>index</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">bind</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>localhost:8081<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">run</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span>await
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">extract</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">_req</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span>ServiceRequest</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>, Error<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Here is a place for your code to get user permissions/grants from a request
</span>    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> For example from a token or database
</span>    
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Stub example
</span>    <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-macro z-rust">vec!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-constant z-other z-rust">ROLE_ADMIN</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_string</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Данный подход добавляет гибкости и позволяет нам реализовывать авторизацию вне зависимости от способов аутентификации и хранения привилегий пользователей: это может быть JWT-токен, база данных, промежуточный кэш или любое другое решение.</p>
<p>После чего мы можем расставлять ограничения непосредственно над нашими ресурсами:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">actix_web_grants<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">proc_macro<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>has_roles</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">get</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>/secure<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">has_roles</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>ROLE_ADMIN<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">macro_secured</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> HttpResponse</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-path z-rust">HttpResponse<span class="z-punctuation z-accessor z-rust">::</span></span>Ok<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">body</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>ADMIN_RESPONSE<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Возможность влиять на политику доступа напрямую в коде является отличительной частью actix-web-grants, снижая дублирование объектов доступа и предоставляя нам наглядную информацию о необходимых привилегиях.</p>
<p>Для полноты картины, написаны минимальные примеры приложений с идентичным профилем использования и проведены замеры производительности процесса авторизации (на базе <a rel="noopener" target="_blank" href="https://github.com/wg/wrk">wrk</a>) для удовлетворения собственного интереса.</p>
<p>Примеры написаны с упрощенной реализацией модели RBAC для двух тест-кейсов авторизации: запрос к ресурсу разрешен и отклонен, в соответствие с наличием необходимых ролей. Для аутентификации использовались заглушки. Весь код опубликован на GitHub: <em><a rel="noopener" target="_blank" href="https://github.com/DDtKey/actix-web-authz-benchmark">actix-web-authz-benchmark</a></em> (больше примеров всегда можно найти на страницах самих проектов).</p>
<p>Результаты бенчмарка можете наблюдать в таблице:</p>
<div class="table-responsive">
    <table class="table table-bordered">
      <tr>
       <td rowspan="2" align="center">Benchmark</td>
       <td colspan="2" align="center"><strong>casbin-rs</strong></td>
       <td colspan="2" align="center"><strong>actix-web-grants</strong></td>
      </tr>
      <tr>
       <td>Latency</td>
       <td>Req/Sec</td>
       <td>Latency</td>
       <td>Req/Sec</td>
      </tr>
      <tr>
       <td>Allowed Endpoint</td>
       <td>6.18 ms</td>
       <td>16.27k</td>
       <td>4.41 ms</td>
       <td>22.69k</td>
      </tr>
      <tr>
       <td>Denied Endpoint</td>
       <td>6.70 ms</td>
       <td>14.98k</td>
       <td>4.94 ms</td>
       <td>20.23k</td>
      </tr>
    </table>
</div>
<blockquote>
<p><em>rustc: v1.52.0 (stable); CPU: 2,6 GHz 6-Core Intel Core i7; RAM: 16 GB</em></p>
</blockquote>
<p>Таким образом, мы видим, что <a rel="noopener" target="_blank" href="https://github.com/DDtKey/actix-web-grants">actix-web-grants</a> позволяет более просто интегрировать и администрировать политики доступа над конечным точками (endpoint), при этом не уступает в производительности по сравнению с <a rel="noopener" target="_blank" href="https://github.com/casbin/casbin-rs">casbin-rs</a>.</p>
<h4 id="post-scriptum">Post Scriptum</h4>
<p>Данная библиотека пока не имеет в своём арсенале интеграций с множеством веб-фреймворков, но у меня есть планы по вынесению некоторых абстракций и написанию модулей под другие фреймворки, внесению некоторых улучшений (например, возможность наследования ролей и поддержки пользовательских типов). Буду рад любым предложениям и вкладу!</p>

        </section>

        
            <div class="post-tags">
                <nav class="nav tags">
                    <ul class="tags">
                        
                            <li><a href=https://ddtkey.com/tags/rust/>rust</a></li>
                        
                            <li><a href=https://ddtkey.com/tags/authz/>authz</a></li>
                        
                    </ul>
                </nav>
            </div>
        

    </article>
</main>



        
        
    </div>
</body>

</html>
